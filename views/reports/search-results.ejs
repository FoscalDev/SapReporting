<!-- Breadcrumb -->
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">Inicio</a></li>
        <li class="breadcrumb-item active">Resultados de Búsqueda</li>
    </ol>
</nav>

<!-- Header -->
<div class="row mb-4">
    <div class="col-12">
        <h1><i class="fas fa-search me-2"></i>Resultados de Búsqueda</h1>
        <p class="text-muted">
            <% if (totalResults > 0) { %>
                Se encontraron <strong><%= totalResults %></strong> empleados que coinciden con los criterios de búsqueda
            <% } else { %>
                No se encontraron empleados que coincidan con los criterios de búsqueda
            <% } %>
        </p>
    </div>
</div>

<!-- Filtros aplicados -->
<% if (Object.keys(filters).length > 0) { %>
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-filter me-2"></i>Filtros Aplicados</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <% if (filters.jobDescription) { %>
                        <div class="col-md-4">
                            <span class="badge bg-primary me-2">Cargo:</span>
                            <strong><%= filters.jobDescription %></strong>
                        </div>
                    <% } %>
                    <% if (filters.organizationalUnit) { %>
                        <div class="col-md-4">
                            <span class="badge bg-success me-2">Unidad Org.:</span>
                            <strong><%= filters.organizationalUnit %></strong>
                        </div>
                    <% } %>
                    <% if (filters.personnelArea) { %>
                        <div class="col-md-4">
                            <span class="badge bg-info me-2">Área Personal:</span>
                            <strong><%= filters.personnelArea %></strong>
                        </div>
                    <% } %>
                </div>
                <div class="mt-3">
                    <a href="/search" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-times me-1"></i>Limpiar Filtros
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
<% } %>

<!-- Formulario de búsqueda -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-search me-2"></i>Nueva Búsqueda</h6>
            </div>
            <div class="card-body">
                <form method="GET" action="/search">
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">Descripción del Cargo</label>
                            <input type="text" class="form-control" name="job" 
                                   placeholder="Ej: AUXILIAR" value="<%= filters.jobDescription || '' %>">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Unidad Organizacional</label>
                            <input type="text" class="form-control" name="unit" 
                                   placeholder="Ej: CIRUGIA" value="<%= filters.organizationalUnit || '' %>">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Área de Personal</label>
                            <select class="form-select" name="area">
                                <option value="">Todas las áreas</option>
                                <option value="14" <%= filters.personnelArea === '14' ? 'selected' : '' %>>Pensionado Activo CO</option>
                                <option value="11" <%= filters.personnelArea === '11' ? 'selected' : '' %>>Asistenciales CO</option>
                                <option value="10" <%= filters.personnelArea === '10' ? 'selected' : '' %>>Administrativos CO</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-3">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search me-1"></i>Buscar
                        </button>
                        <a href="/" class="btn btn-secondary">
                            <i class="fas fa-home me-1"></i>Ver Todos
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Resultados -->
<% if (employees && employees.length > 0) { %>
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-table me-2"></i>Resultados (<%= totalResults %>)</h5>
                <div>
                    <button class="btn btn-outline-primary btn-sm" onclick="exportResults()">
                        <i class="fas fa-download me-1"></i>Exportar CSV
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Cargo</th>
                                <th>Unidad Org.</th>
                                <th>Área Personal</th>
                                <th>Salario Base</th>
                                <th>Horas</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% employees.forEach(employee => { %>
                                <tr>
                                    <td><%= employee.id %></td>
                                    <td><%= employee.name || 'Sin nombre' %></td>
                                    <td>
                                        <small class="text-muted d-block"><%= employee.jobCode %></small>
                                        <%= employee.jobDescription %>
                                    </td>
                                    <td>
                                        <small class="text-muted d-block"><%= employee.organizationalUnit.code %></small>
                                        <%= employee.organizationalUnit.description %>
                                    </td>
                                    <td>
                                        <small class="text-muted d-block"><%= employee.personnelArea.code %></small>
                                        <%= employee.personnelArea.description %>
                                    </td>
                                    <td class="text-end">
                                        <strong><%= new Intl.NumberFormat('es-CO', {
                                            style: 'currency',
                                            currency: 'COP',
                                            minimumFractionDigits: 0
                                        }).format(employee.baseSalary) %></strong>
                                    </td>
                                    <td class="text-center"><%= employee.contractedHours %>h</td>
                                    <td>
                                        <a href="/employee/<%= employee.id %>" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye me-1"></i>Ver
                                        </a>
                                    </td>
                                </tr>
                            <% }); %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<% } else { %>
<!-- Sin resultados -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center py-5">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">No se encontraron resultados</h4>
                <p class="text-muted">Intenta ajustar los criterios de búsqueda o ver todos los empleados</p>
                <a href="/" class="btn btn-primary">
                    <i class="fas fa-users me-1"></i>Ver Todos los Empleados
                </a>
            </div>
        </div>
    </div>
</div>
<% } %>

<script>
    function exportResults() {
        const rows = document.querySelectorAll('table tbody tr');
        let csv = 'ID,Nombre,Cargo,Código Cargo,Unidad Org,Código Unidad,Área Personal,Salario Base,Horas Contrato\n';
        
        rows.forEach(row => {
            const cells = row.cells;
            if (cells.length > 0) {
                const rowData = [
                    cells[0].textContent,
                    cells[1].textContent,
                    cells[2].textContent.replace(/\n/g, ' ').trim(),
                    cells[2].querySelector('small').textContent,
                    cells[3].textContent.replace(/\n/g, ' ').trim(),
                    cells[3].querySelector('small').textContent,
                    cells[4].textContent.replace(/\n/g, ' ').trim(),
                    cells[5].textContent,
                    cells[6].textContent
                ];
                csv += rowData.map(field => `"${field}"`).join(',') + '\n';
            }
        });

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'resultados_busqueda_' + new Date().toISOString().split('T')[0] + '.csv';
        a.click();
        window.URL.revokeObjectURL(url);
    }
</script>
